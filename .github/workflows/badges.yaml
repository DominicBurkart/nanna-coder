name: badges
on:
  push:
    branches: [main]

jobs:
  update-badges:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute lines of code
        id: loc
        run: |
          COUNT=$(git ls-files -z '*.rs' | xargs -0 cat 2>/dev/null | wc -l)
          LABEL=$(echo "${COUNT:-0}" | numfmt --to=si)
          echo "label=$LABEL" >> $GITHUB_OUTPUT

      - name: Compute contributors
        id: contrib
        run: |
          COUNT=$(git log --all --format="%ae" | grep -v "test@example.com" | sort -u | wc -l)
          LABEL=$(echo "${COUNT:-0}" | numfmt --to=si)
          echo "label=$LABEL" >> $GITHUB_OUTPUT

      - name: Generate badge SVGs
        run: |
          mkdir -p development_metadata/badges
          curl -o development_metadata/badges/lines_of_code.svg \
            "https://img.shields.io/badge/lines%20of%20code-${{ steps.loc.outputs.label }}-informational"
          curl -o development_metadata/badges/contributors.svg \
            "https://img.shields.io/badge/contributors-${{ steps.contrib.outputs.label }}-informational"

      - name: Commit badges
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add development_metadata/badges/
          git diff --cached --quiet || git commit -m "update badges"
          git push || true
