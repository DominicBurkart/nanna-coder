name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    strategy:
      matrix:
        rust: [stable, beta]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main

    - name: Setup Nix cache
      uses: DeterminateSystems/magic-nix-cache-action@main

    - name: Run tests
      run: nix develop --command cargo test --workspace --verbose

    - name: Run clippy
      run: nix develop --command cargo clippy --workspace --all-targets -- -D warnings

    - name: Check formatting
      run: nix develop --command cargo fmt --all -- --check

    - name: Security audit
      run: nix develop --command cargo audit

  build:
    name: Build Packages
    runs-on: ubuntu-latest
    needs: test
    strategy:
      matrix:
        target: [x86_64-linux, aarch64-linux]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main

    - name: Setup Nix cache
      uses: DeterminateSystems/magic-nix-cache-action@main

    - name: Build workspace
      run: nix build .#packages.${{ matrix.target }}.nanna-coder

    - name: Upload binary artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nanna-coder-${{ matrix.target }}
        path: result/bin/*

  build-containers:
    name: Build Container Images
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main

    - name: Setup Nix cache
      uses: DeterminateSystems/magic-nix-cache-action@main

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build harness container
      run: nix build .#harnessImage

    - name: Load and tag harness image
      run: |
        docker load < result
        docker tag nanna-coder-harness:latest ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/harness:${{ github.sha }}
        docker tag nanna-coder-harness:latest ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/harness:latest

    - name: Build ollama container
      run: nix build .#ollamaImage

    - name: Load and tag ollama image
      run: |
        docker load < result
        docker tag nanna-coder-ollama:latest ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/ollama:${{ github.sha }}
        docker tag nanna-coder-ollama:latest ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/ollama:latest

    - name: Push images
      if: github.event_name != 'pull_request'
      run: |
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/harness:${{ github.sha }}
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/harness:latest
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/ollama:${{ github.sha }}
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/ollama:latest

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-containers
    if: github.event_name != 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/harness:latest
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [test, build, build-containers]
    if: github.event_name == 'release'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main

    - name: Setup Nix cache
      uses: DeterminateSystems/magic-nix-cache-action@main

    - name: Build release artifacts
      run: |
        nix build .#packages.x86_64-linux.nanna-coder
        cp result/bin/harness harness-x86_64-linux

        nix build .#packages.aarch64-linux.nanna-coder
        cp result/bin/harness harness-aarch64-linux

    - name: Upload release artifacts
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./harness-x86_64-linux
        asset_name: harness-x86_64-linux
        asset_content_type: application/octet-stream

    - name: Upload ARM64 release artifacts
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./harness-aarch64-linux
        asset_name: harness-aarch64-linux
        asset_content_type: application/octet-stream