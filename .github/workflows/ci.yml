name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test-matrix:
    name: ${{ matrix.test-type }} (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            test-type: unit
          - os: ubuntu-latest
            test-type: lint
          - os: ubuntu-latest
            test-type: security
          - os: macos-latest
            test-type: unit
          - os: windows-latest
            test-type: unit

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Nix
      if: runner.os != 'Windows'
      uses: DeterminateSystems/nix-installer-action@main

    - name: Configure Cachix
      if: runner.os != 'Windows'
      uses: cachix/cachix-action@v15
      with:
        name: nanna-coder
        authToken: ${{ secrets.CACHIX_AUTH }}
        pushFilter: "(-source$|nixpkgs\\.tar\\.gz$)"
        skipPush: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork }}

    - name: Setup Rust toolchain (Windows)
      if: runner.os == 'Windows'
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: stable
        components: rustfmt, clippy

    - name: Setup Rust toolchain (macOS)
      if: runner.os == 'macOS'
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: stable
        components: rustfmt, clippy

    - name: Install cargo-nextest (non-Nix)
      if: runner.os != 'Linux'
      uses: taiki-e/install-action@v2
      with:
        tool: cargo-nextest

    - name: Run unit tests
      if: matrix.test-type == 'unit'
      shell: bash
      run: |
        if [ "${{ runner.os }}" = "Linux" ]; then
          nix develop --command cargo nextest run --workspace --lib --all-features
        else
          cargo nextest run --workspace --lib --all-features
        fi

    - name: Run lint checks
      if: matrix.test-type == 'lint'
      shell: bash
      run: |
        nix develop --command cargo clippy --workspace --all-targets --all-features -- -D warnings
        nix develop --command cargo fmt --all -- --check
        nix develop --command cargo doc --no-deps --workspace

    - name: Run security checks
      if: matrix.test-type == 'security'
      shell: bash
      run: |
        nix develop --command cargo audit
        nix develop --command cargo deny check
        nix develop --command cargo tarpaulin --skip-clean --ignore-tests --out Lcov --output-dir . --timeout 1800

    - name: Upload coverage reports
      if: matrix.test-type == 'security'
      uses: codecov/codecov-action@v3
      with:
        file: lcov.info
        fail_ci_if_error: false

  build-matrix:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.runner }}
    needs: test-matrix
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-linux
            runner: ubuntu-latest
            cross: false
          - target: aarch64-linux
            runner: ubuntu-latest
            cross: true
          - target: x86_64-darwin
            runner: macos-latest
            cross: false
          - target: aarch64-darwin
            runner: macos-latest
            cross: true

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Nix (Linux)
      if: runner.os == 'Linux'
      uses: DeterminateSystems/nix-installer-action@main

    - name: Configure Cachix (Linux)
      if: runner.os == 'Linux'
      uses: cachix/cachix-action@v15
      with:
        name: nanna-coder
        authToken: ${{ secrets.CACHIX_AUTH }}
        pushFilter: "(-source$|nixpkgs\\.tar\\.gz$)"

    - name: Setup Rust toolchain (macOS)
      if: runner.os == 'macOS'
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: stable

    - name: Setup cross-compilation (aarch64)
      if: matrix.cross && runner.os == 'macOS'
      run: rustup target add aarch64-apple-darwin

    - name: Build workspace (Nix)
      if: runner.os == 'Linux'
      run: |
        if [ "${{ matrix.cross }}" = "true" ]; then
          nix build .#packages.${{ matrix.target }}.nanna-coder || nix build .#nanna-coder
        else
          nix build .#nanna-coder
        fi

    - name: Build workspace (Cargo)
      if: runner.os == 'macOS'
      run: |
        if [ "${{ matrix.cross }}" = "true" ]; then
          cargo build --release --target aarch64-apple-darwin
        else
          cargo build --release
        fi

    - name: Prepare artifacts (Nix)
      if: runner.os == 'Linux'
      run: |
        mkdir -p artifacts
        ARTIFACT_FOUND=false
        if [ -d "result/bin" ]; then
          for binary in result/bin/*; do
            if [ -f "$binary" ]; then
              cp "$binary" artifacts/
              ARTIFACT_FOUND=true
            fi
          done
        elif [ -L "result" ] && [ -f "result" ]; then
          cp result "artifacts/nanna-coder-${{ matrix.target }}"
          ARTIFACT_FOUND=true
        fi
        if [ "$ARTIFACT_FOUND" = "false" ]; then
          echo "No artifacts found after Nix build"
          ls -la result* 2>/dev/null || true
          exit 1
        fi
        ls -lah artifacts/

    - name: Prepare artifacts (Cargo)
      if: runner.os == 'macOS'
      run: |
        mkdir -p artifacts
        if [ "${{ matrix.cross }}" = "true" ]; then
          BINARY_PATH="target/aarch64-apple-darwin/release/harness"
        else
          BINARY_PATH="target/release/harness"
        fi
        if [ ! -f "$BINARY_PATH" ]; then
          echo "Expected binary not found at $BINARY_PATH"
          find target -name "harness" -type f 2>/dev/null || true
          exit 1
        fi
        cp "$BINARY_PATH" "artifacts/harness-${{ matrix.target }}"
        ls -lah artifacts/

    - name: Upload binary artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nanna-coder-${{ matrix.target }}
        path: artifacts/*
        if-no-files-found: warn

  build-containers:
    name: Build ${{ matrix.image }} (${{ matrix.arch }})
    runs-on: ubuntu-latest
    needs: test-matrix
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64]
        image: [harness, ollama]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main

    - name: Configure Cachix
      uses: cachix/cachix-action@v15
      with:
        name: nanna-coder
        authToken: ${{ secrets.CACHIX_AUTH }}
        pushFilter: "(-source$|nixpkgs\\.tar\\.gz$)"
        skipPush: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork }}

    - name: Log in to Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build container image
      run: |
        case "${{ matrix.image }}" in
          "harness") nix build .#harnessImage --print-build-logs ;;
          "ollama")  nix build .#ollamaImage  --print-build-logs ;;
        esac

    - name: Load and tag container image
      shell: bash
      run: |
        case "${{ matrix.image }}" in
          "harness") IMAGE_NAME="nanna-coder-harness"; REGISTRY_NAME="harness"; NIX_ATTR="harnessImage" ;;
          "ollama")  IMAGE_NAME="nanna-coder-ollama";  REGISTRY_NAME="ollama";  NIX_ATTR="ollamaImage"  ;;
        esac

        if ! nix run .#${NIX_ATTR}.copyToDockerDaemon; then
          echo "Failed to load image via copyToDockerDaemon"
          exit 1
        fi

        if ! docker image inspect ${IMAGE_NAME}:latest >/dev/null 2>&1; then
          echo "Image ${IMAGE_NAME}:latest not found after loading"
          docker images
          exit 1
        fi

        REPO_LOWERCASE=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
        docker tag ${IMAGE_NAME}:latest ${{ env.REGISTRY }}/${REPO_LOWERCASE}/${REGISTRY_NAME}:${{ github.sha }}
        docker tag ${IMAGE_NAME}:latest ${{ env.REGISTRY }}/${REPO_LOWERCASE}/${REGISTRY_NAME}:latest

    - name: Push container images
      if: github.event_name != 'pull_request'
      run: |
        case "${{ matrix.image }}" in
          "harness") REGISTRY_NAME="harness" ;;
          "ollama")  REGISTRY_NAME="ollama"  ;;
        esac
        REPO_LOWERCASE=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
        docker push ${{ env.REGISTRY }}/${REPO_LOWERCASE}/${REGISTRY_NAME}:${{ github.sha }}
        docker push ${{ env.REGISTRY }}/${REPO_LOWERCASE}/${REGISTRY_NAME}:latest

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-containers
    if: github.event_name != 'pull_request'
    permissions:
      contents: read
      security-events: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set lowercase repository name
      id: repo
      run: echo "lowercase=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ steps.repo.outputs.lowercase }}/harness:latest
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'

  cache-maintenance:
    name: Cache Maintenance
    runs-on: ubuntu-latest
    needs: [test-matrix, build-matrix, build-containers]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main

    - name: Configure Cachix
      uses: cachix/cachix-action@v15
      with:
        name: nanna-coder
        authToken: ${{ secrets.CACHIX_AUTH }}
        pushFilter: "(-source$|nixpkgs\\.tar\\.gz$)"

    - name: Cache analytics and reporting
      run: |
        echo "## Binary Cache Performance Report" >> $GITHUB_STEP_SUMMARY
        echo "Generated: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        nix run .#cache-analytics >> $GITHUB_STEP_SUMMARY

  release:
    name: Create Release (${{ matrix.target }})
    runs-on: ${{ matrix.runner }}
    needs: [test-matrix, build-matrix, build-containers]
    if: github.event_name == 'release'
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-linux
            runner: ubuntu-latest
          - target: aarch64-linux
            runner: ubuntu-latest
          - target: x86_64-darwin
            runner: macos-latest
          - target: aarch64-darwin
            runner: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Nix
      if: runner.os == 'Linux'
      uses: DeterminateSystems/nix-installer-action@main

    - name: Configure Cachix
      if: runner.os == 'Linux'
      uses: cachix/cachix-action@v15
      with:
        name: nanna-coder
        authToken: ${{ secrets.CACHIX_AUTH }}
        pushFilter: "(-source$|nixpkgs\\.tar\\.gz$)"

    - name: Setup Rust toolchain (macOS)
      if: runner.os == 'macOS'
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: stable

    - name: Build release artifact (Linux)
      if: runner.os == 'Linux'
      run: |
        nix build .#packages.${{ matrix.target }}.nanna-coder
        cp result/bin/harness harness-${{ matrix.target }}

    - name: Build release artifact (macOS)
      if: runner.os == 'macOS'
      run: |
        if [ "${{ matrix.target }}" = "aarch64-darwin" ]; then
          rustup target add aarch64-apple-darwin
          cargo build --release --target aarch64-apple-darwin
          cp target/aarch64-apple-darwin/release/harness harness-${{ matrix.target }}
        else
          cargo build --release
          cp target/release/harness harness-${{ matrix.target }}
        fi

    - name: Upload release artifact
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./harness-${{ matrix.target }}
        asset_name: harness-${{ matrix.target }}
        asset_content_type: application/octet-stream

  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [test-matrix, build-matrix, build-containers]
    if: always()

    steps:
    - name: Generate CI Summary
      run: |
        echo "## CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Test Matrix | ${{ needs.test-matrix.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build Matrix | ${{ needs.build-matrix.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Container Builds | ${{ needs.build-containers.result }} |" >> $GITHUB_STEP_SUMMARY

    - name: Check for failures
      if: needs.test-matrix.result == 'failure' || needs.build-matrix.result == 'failure' || needs.build-containers.result == 'failure'
      run: exit 1
