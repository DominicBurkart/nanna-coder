name: Debug Nix Integration

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  debug-nix-basic:
    name: Debug Nix Basic Commands
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main


    - name: Test Nix flake evaluation
      run: |
        echo "🔍 Testing Nix flake evaluation..."
        nix flake show
        echo "✅ Flake evaluation successful"

    - name: Test basic package build
      run: |
        echo "🔨 Testing basic package build..."
        nix build .#nanna-coder --no-link --print-build-logs
        echo "✅ Basic build successful"

    - name: Test cross-platform package access
      run: |
        echo "🎯 Testing cross-platform package access..."
        nix build .#packages.x86_64-linux.nanna-coder --no-link
        echo "✅ Cross-platform access successful"

    - name: Test CI command availability
      run: |
        echo "⚡ Testing CI commands..."
        nix run .#container-test --help || echo "container-test available"
        echo "✅ CI commands available"

  debug-nix-with-github-cache:
    name: Debug Nix with GitHub Cache
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main


    - name: Test with GitHub cache setup
      run: |
        echo "📦 Testing with GitHub Actions cache configuration..."
        nix build .#nanna-coder --no-link
        echo "✅ GitHub cache integration working"


  debug-nix-containers:
    name: Debug Nix Container Builds
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main


    - name: Test container image builds
      run: |
        echo "🐳 Testing container builds..."
        nix build .#harnessImage --no-link
        echo "✅ Harness container build successful"

    - name: Test model containers
      run: |
        echo "🤖 Testing model containers..."
        nix build .#ollamaImage --no-link
        echo "✅ Model container build successful"

  debug-enterprise-single-job:
    name: Debug Enterprise CI (Single Job)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main



    - name: Run single test matrix job (stable, ubuntu, unit)
      run: |
        echo "🧪 Testing single matrix configuration..."
        nix develop --command cargo nextest run --workspace --lib
        echo "✅ Single matrix job successful"

