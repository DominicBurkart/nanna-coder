name: Debug Nix Integration

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  debug-nix-basic:
    name: Debug Nix Basic Commands
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main


    - name: Test Nix flake evaluation
      run: |
        echo "ğŸ” Testing Nix flake evaluation..."
        nix flake show
        echo "âœ… Flake evaluation successful"

    - name: Test basic package build
      run: |
        echo "ğŸ”¨ Testing basic package build..."
        nix build .#nanna-coder --no-link --print-build-logs
        echo "âœ… Basic build successful"

    - name: Test cross-platform package access
      run: |
        echo "ğŸ¯ Testing cross-platform package access..."
        nix build .#packages.x86_64-linux.nanna-coder --no-link
        echo "âœ… Cross-platform access successful"

    - name: Test CI command availability
      run: |
        echo "âš¡ Testing CI commands..."
        nix run .#container-test --help || echo "container-test available"
        echo "âœ… CI commands available"

  debug-nix-with-github-cache:
    name: Debug Nix with GitHub Cache
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main


    - name: Test with GitHub cache setup
      run: |
        echo "ğŸ“¦ Testing with GitHub Actions cache configuration..."
        nix build .#nanna-coder --no-link
        echo "âœ… GitHub cache integration working"


  debug-nix-containers:
    name: Debug Nix Container Builds
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main


    - name: Test container image builds
      run: |
        echo "ğŸ³ Testing container builds..."
        nix build .#harnessImage --no-link
        echo "âœ… Harness container build successful"

    - name: Test model containers
      run: |
        echo "ğŸ¤– Testing model containers..."
        nix build .#ollamaImage --no-link
        echo "âœ… Model container build successful"

  debug-enterprise-single-job:
    name: Debug Enterprise CI (Single Job)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main



    - name: Run single test matrix job (stable, ubuntu, unit)
      run: |
        echo "ğŸ§ª Testing single matrix configuration..."
        nix develop --command cargo nextest run --workspace --lib
        echo "âœ… Single matrix job successful"

