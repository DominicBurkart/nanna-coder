name: Debug Nix Integration

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  debug-nix-basic:
    name: Debug Nix Basic Commands
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main

    - name: Cache Nix store (Free GitHub-native caching)
      uses: nix-community/cache-nix-action@v5
      with:
        primary-key: nix-debug-${{ github.job }}-${{ hashFiles('**/flake.lock') }}
        restore-prefixes-first-match: nix-debug-${{ github.job }}-
        gc-before-save: true
        gc-max-store-size-linux: 1073741824

    - name: Test Nix flake evaluation
      run: |
        echo "üîç Testing Nix flake evaluation..."
        nix flake show
        echo "‚úÖ Flake evaluation successful"

    - name: Test basic package build
      run: |
        echo "üî® Testing basic package build..."
        nix build .#nanna-coder --no-link --print-build-logs
        echo "‚úÖ Basic build successful"

    - name: Test cross-platform package access
      run: |
        echo "üéØ Testing cross-platform package access..."
        nix build .#packages.x86_64-linux.nanna-coder --no-link
        echo "‚úÖ Cross-platform access successful"

    - name: Test CI command availability
      run: |
        echo "‚ö° Testing CI commands..."
        nix run .#ci-cache-optimize --help || echo "ci-cache-optimize available"
        nix run .#cache-analytics --help || echo "cache-analytics available"
        nix run .#container-test --help || echo "container-test available"
        echo "‚úÖ CI commands available"

  debug-nix-with-github-cache:
    name: Debug Nix with GitHub Cache
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main

    - name: Cache Nix store (Free GitHub-native caching)
      uses: nix-community/cache-nix-action@v5
      with:
        primary-key: nix-debug-${{ github.job }}-${{ hashFiles('**/flake.lock') }}
        restore-prefixes-first-match: nix-debug-${{ github.job }}-
        gc-before-save: true
        gc-max-store-size-linux: 1073741824

    - name: Test with GitHub cache setup
      run: |
        echo "üì¶ Testing with GitHub Actions cache configuration..."
        nix build .#nanna-coder --no-link
        echo "‚úÖ GitHub cache integration working"

    - name: Test CI optimization commands
      run: |
        echo "‚ö° Testing CI optimization..."
        nix run .#ci-cache-optimize
        echo "‚úÖ CI optimization successful"

  debug-nix-containers:
    name: Debug Nix Container Builds
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main

    - name: Cache Nix store (Free GitHub-native caching)
      uses: nix-community/cache-nix-action@v5
      with:
        primary-key: nix-debug-${{ github.job }}-${{ hashFiles('**/flake.lock') }}
        restore-prefixes-first-match: nix-debug-${{ github.job }}-
        gc-before-save: true
        gc-max-store-size-linux: 1073741824

    - name: Test container image builds
      run: |
        echo "üê≥ Testing container builds..."
        nix build .#harnessImage --no-link
        echo "‚úÖ Harness container build successful"

    - name: Test model containers
      run: |
        echo "ü§ñ Testing model containers..."
        nix build .#qwen3-model --no-link
        echo "‚úÖ Model container build successful"

  debug-enterprise-single-job:
    name: Debug Enterprise CI (Single Job)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main

    - name: Cache Nix store (Free GitHub-native caching)
      uses: nix-community/cache-nix-action@v5
      with:
        primary-key: nix-debug-${{ github.job }}-${{ hashFiles('**/flake.lock') }}
        restore-prefixes-first-match: nix-debug-${{ github.job }}-
        gc-before-save: true
        gc-max-store-size-linux: 1073741824

    - name: Note cache strategy
      run: |
        echo "üì¶ Using cache-nix-action for GitHub-native caching"
        echo "üîÑ No external binary cache dependencies"

    - name: Run single test matrix job (stable, ubuntu, unit)
      run: |
        echo "üß™ Testing single matrix configuration..."
        nix develop --command cargo nextest run --workspace --lib
        echo "‚úÖ Single matrix job successful"

    - name: Test cache analytics
      run: |
        echo "üìä Testing cache analytics..."
        nix run .#cache-analytics
        echo "‚úÖ Cache analytics successful"